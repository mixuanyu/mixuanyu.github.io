<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园规则怪谈</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .game-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 30px;
        }
        .rules {
            background-color: #fff8e1;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
        }
        .rule-item {
            margin-bottom: 10px;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 15px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #b71c1c;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .save-load {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .save-slots {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .save-slot {
            flex: 1;
            padding: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
        }
        .save-slot:hover {
            background-color: #d0d0d0;
        }
        .save-slot.empty {
            color: #888;
            font-style: italic;
        }
        .inventory {
            margin-top: 20px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
        }
        .inventory-item {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 5px;
            padding: 3px 8px;
            background-color: #c8e6c9;
            border-radius: 3px;
        }
        .hidden {
            display: none;
        }
        .ending {
            text-align: center;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 8px;
            margin-top: 20px;
        }
        .good-ending {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .bad-ending {
            background-color: #ffebee;
            color: #c62828;
        }
        .tutorial {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .tutorial-step {
            margin-bottom: 10px;
        }
        .key-hint {
            display: inline-block;
            padding: 2px 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            border: 1px solid #b0b0b0;
            font-family: monospace;
            margin: 0 3px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="title">校园规则怪谈</h1>
        
        <div id="intro-screen">
            <p>欢迎来到青山中学。这是一所看似普通的学校，但请记住：在这里，规则就是一切。</p>
            <p>违反规则的后果...你不会想知道的。</p>
            <p>请仔细阅读并遵守所有规则，祝你好运。</p>
            <button id="start-game">开始游戏</button>
        </div>
        
        <div id="tutorial-screen" class="hidden">
            <div class="tutorial">
                <h3>新手教程</h3>
                <div class="tutorial-step">
                    <p><strong>基本操作：</strong></p>
                    <p>使用屏幕下方的按钮进行移动、互动等操作。</p>
                    <p>也可以使用快捷键：<span class="key-hint">M</span>移动，<span class="key-hint">I</span>互动，<span class="key-hint">C</span>查看物品。</p>
                </div>
                <div class="tutorial-step">
                    <p><strong>规则系统：</strong></p>
                    <p>每个地点都有特定的规则，显示在屏幕上方。</p>
                    <p>按<span class="key-hint">R</span>键可以随时查看所有已知规则。</p>
                    <p>违反规则会降低你的理智值，理智值归零会导致游戏结束。</p>
                </div>
                <div class="tutorial-step">
                    <p><strong>存档系统：</strong></p>
                    <p>游戏提供5个存档位，可以随时保存进度。</p>
                    <p>点击存档位选择，然后点击"存档"或"读档"按钮。</p>
                </div>
                <button id="skip-tutorial">跳过教程</button>
                <button id="start-after-tutorial">开始游戏</button>
            </div>
        </div>
        
        <div id="game-screen" class="hidden">
            <div class="rules">
                <h3>校园规则（请严格遵守） <span style="float:right;font-size:0.8em;font-weight:normal">按<span class="key-hint">R</span>查看所有规则</span></h3>
                <div id="current-rules"></div>
            </div>
            
            <div id="location-description"></div>
            
            <div class="actions">
                <button id="move-btn">移动 (M)</button>
                <button id="interact-btn">互动 (I)</button>
                <button id="check-inventory-btn">查看物品 (C)</button>
                <button id="view-rules-btn">查看规则 (R)</button>
            </div>
            
            <div id="move-options" class="hidden">
                <h4>选择要去的地方：</h4>
                <div id="location-options"></div>
                <button id="cancel-move">取消</button>
            </div>
            
            <div id="interact-options" class="hidden">
                <h4>选择互动对象：</h4>
                <div id="interact-objects"></div>
                <button id="cancel-interact">取消</button>
            </div>
            
            <div id="inventory-display" class="inventory hidden">
                <h4>你的物品：</h4>
                <div id="inventory-items"></div>
                <button id="close-inventory">关闭</button>
            </div>
            
            <div class="save-load">
                <h3>存档/读档</h3>
                <div class="save-slots">
                    <div class="save-slot" data-slot="1">存档1 <span class="empty">(空)</span></div>
                    <div class="save-slot" data-slot="2">存档2 <span class="empty">(空)</span></div>
                    <div class="save-slot" data-slot="3">存档3 <span class="empty">(空)</span></div>
                    <div class="save-slot" data-slot="4">存档4 <span class="empty">(空)</span></div>
                    <div class="save-slot" data-slot="5">存档5 <span class="empty">(空)</span></div>
                </div>
                <button id="save-game-btn">存档</button>
                <button id="load-game-btn">读档</button>
            </div>
        </div>
        
        <div id="ending-screen" class="hidden">
            <div id="ending-content" class="ending"></div>
            <button id="restart-game">重新开始</button>
        </div>
        
        <div id="all-rules-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center;">
            <div style="background-color: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h2>所有已知规则</h2>
                <div id="all-rules-list"></div>
                <button id="close-all-rules" style="margin-top: 15px;">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            currentLocation: 'gate',
            day: 1,
            time: 'morning',
            sanity: 100,
            inventory: [],
            knownRules: [],
            brokenRules: [],
            hasSeen: {},
            endings: [],
            selectedSlot: null,
            tutorialCompleted: false
        };

        // 游戏数据
        const gameData = {
            locations: {
                gate: {
                    name: '校门口',
                    description: '你站在青山中学的校门口。铁门半开着，门卫室里似乎有人影晃动。',
                    rules: [
                        "规则1：进入学校前，请确保你的校牌是蓝色的。如果校牌变成红色，立即离开学校并报告门卫。",
                        "规则2：门卫永远穿着灰色制服。如果看到穿黑色制服的门卫，不要与他对话，立即进入教学楼。"
                    ],
                    adjacent: ['courtyard', 'guard_room'],
                    interactions: ['gate_guard', 'school_sign']
                },
                courtyard: {
                    name: '校园广场',
                    description: '开阔的校园广场，中央有一棵古老的槐树。周围是几栋教学楼。',
                    rules: [
                        "规则3：校园广场的槐树在中午12点会投下阴影。如果发现阴影方向与太阳位置不符，立即闭上眼睛数到30。",
                        "规则4：广场上的鸽子总是成双出现。如果看到单独一只鸽子，不要喂食或接近它。"
                    ],
                    adjacent: ['gate', 'classroom_building', 'cafeteria', 'library'],
                    interactions: ['old_tree', 'pigeons', 'statue']
                },
                classroom_building: {
                    name: '教学楼',
                    description: '三层的教学楼，走廊两侧是教室。墙上贴着各种公告和学生的作品。',
                    rules: [
                        "规则5：教室的窗户在雨天会映出人影。如果数到的人影数量与教室里实际人数不符，不要看向窗户。",
                        "规则6：如果听到三楼传来钢琴声，但音乐教室在一楼，不要上楼查看。"
                    ],
                    adjacent: ['courtyard', 'classroom', 'music_room', 'toilet'],
                    interactions: ['notice_board', 'classroom_door']
                },
                classroom: {
                    name: '教室',
                    description: '你的教室，桌椅整齐排列。黑板上有未擦净的数学公式。',
                    rules: [
                        "规则7：教室里最后一排的座位总是空着的。如果有人坐在那里，不要与他/她说话。",
                        "规则8：如果你的同桌突然变得沉默寡言，且眼睛不再眨动，立即报告老师并要求换座位。"
                    ],
                    adjacent: ['classroom_building'],
                    interactions: ['desk', 'blackboard', 'classmate']
                },
                cafeteria: {
                    name: '食堂',
                    description: '宽敞的食堂，飘着食物的香气。午餐时间这里总是很拥挤。',
                    rules: [
                        "规则9：食堂提供的肉类食品如果是红色的，不要食用。",
                        "规则10：食堂阿姨总是面带微笑。如果看到面无表情的食堂工作人员，不要从她那里取餐。"
                    ],
                    adjacent: ['courtyard'],
                    interactions: ['lunch_lady', 'food_counter']
                },
                library: {
                    name: '图书馆',
                    description: '安静的图书馆，书架排列整齐。角落里有一张阅读桌。',
                    rules: [
                        "规则11：图书馆的《校园历史》一书只有上册。如果发现下册，不要阅读。",
                        "规则12：图书管理员戴眼镜。如果看到不戴眼镜的管理员，不要询问任何问题。"
                    ],
                    adjacent: ['courtyard'],
                    interactions: ['librarian', 'history_book']
                },
                music_room: {
                    name: '音乐教室',
                    description: '摆满乐器的教室，中央是一架老旧的钢琴。',
                    rules: [
                        "规则13：音乐教室的钢琴在无人时会自动演奏。如果听到它演奏《月光奏鸣曲》，立即离开并关上门。",
                        "规则14：音乐教室的镜子不会反射人影。如果你在镜中看到自己，不要触碰任何乐器。"
                    ],
                    adjacent: ['classroom_building'],
                    interactions: ['piano', 'mirror']
                },
                toilet: {
                    name: '厕所',
                    description: '干净的厕所，有轻微的消毒水气味。',
                    rules: [
                        "规则15：厕所的第三个隔间是锁着的。如果发现它打开了，不要使用它。",
                        "规则16：洗手时，如果水变成红色，立即停止使用并报告老师。"
                    ],
                    adjacent: ['classroom_building'],
                    interactions: ['sink', 'mirror']
                },
                guard_room: {
                    name: '门卫室',
                    description: '狭小的门卫室，墙上挂着各种钥匙和监控屏幕。',
                    rules: [
                        "规则17：门卫室的时钟总是快5分钟。如果发现它显示准确时间，不要相信它。",
                        "规则18：门卫不会在下午4点后接受任何报告。如果他在那个时间后主动与你交谈，不要回应。"
                    ],
                    adjacent: ['gate'],
                    interactions: ['guard', 'monitors']
                }
            },
            interactions: {
                gate_guard: {
                    name: '与门卫交谈',
                    description: '门卫从窗口探出头来："请出示你的校牌。"',
                    options: [
                        { text: '出示蓝色校牌', action: 'show_blue_card' },
                        { text: '出示红色校牌', action: 'show_red_card' },
                        { text: '表示忘记带了', action: 'no_card' }
                    ]
                },
                school_sign: {
                    name: '查看校牌',
                    description: '校牌上写着"青山中学"，但有些字迹已经模糊不清。',
                    options: [
                        { text: '仔细辨认模糊的字迹', action: 'read_sign' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                old_tree: {
                    name: '观察老槐树',
                    description: '古老的槐树枝繁叶茂，树干上刻着许多名字。',
                    options: [
                        { text: '查看树干上的名字', action: 'read_names' },
                        { text: '数树下的鸽子', action: 'count_pigeons' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                pigeons: {
                    name: '观察鸽子',
                    description: '几只鸽子在地上啄食，看起来很正常。',
                    options: [
                        { text: '数鸽子的数量', action: 'count_pigeons' },
                        { text: '喂食鸽子', action: 'feed_pigeons' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                statue: {
                    name: '查看雕像',
                    description: '校园创始人的雕像，基座上刻着校训。',
                    options: [
                        { text: '阅读校训', action: 'read_motto' },
                        { text: '观察雕像的面部', action: 'look_statue_face' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                notice_board: {
                    name: '查看公告板',
                    description: '公告板上贴着各种通知和学生作品。',
                    options: [
                        { text: '阅读通知', action: 'read_notices' },
                        { text: '查看学生作品', action: 'view_artworks' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                classroom_door: {
                    name: '教室门',
                    description: '教室的门上有一块小窗，可以看到里面的情况。',
                    options: [
                        { text: '透过窗户查看', action: 'peek_classroom' },
                        { text: '敲门', action: 'knock_door' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                desk: {
                    name: '你的课桌',
                    description: '你的课桌上有刻痕和涂鸦，抽屉里有些书本。',
                    options: [
                        { text: '检查抽屉', action: 'check_drawer' },
                        { text: '阅读桌上的涂鸦', action: 'read_graffiti' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                blackboard: {
                    name: '黑板',
                    description: '黑板上写满了数学公式，角落里画着一个小笑脸。',
                    options: [
                        { text: '尝试解答问题', action: 'solve_math' },
                        { text: '擦掉笑脸', action: 'erase_smiley' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                classmate: {
                    name: '与同桌交谈',
                    description: '你的同桌正在专心做题，似乎没注意到你。',
                    options: [
                        { text: '询问课堂内容', action: 'ask_lesson' },
                        { text: '观察同桌的眼睛', action: 'watch_eyes' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                lunch_lady: {
                    name: '食堂阿姨',
                    description: '食堂阿姨正在分发午餐，队伍排得很长。',
                    options: [
                        { text: '排队取餐', action: 'get_food' },
                        { text: '观察阿姨的表情', action: 'watch_face' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                food_counter: {
                    name: '食物柜台',
                    description: '各种食物陈列在柜台上，冒着热气。',
                    options: [
                        { text: '查看肉类', action: 'check_meat' },
                        { text: '选择素食', action: 'choose_veg' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                librarian: {
                    name: '图书管理员',
                    description: '图书管理员正在整理书架，看起来很忙碌。',
                    options: [
                        { text: '询问《校园历史》', action: 'ask_history_book' },
                        { text: '观察管理员的眼镜', action: 'check_glasses' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                history_book: {
                    name: '《校园历史》',
                    description: '一本厚重的书籍，封面已经有些褪色。',
                    options: [
                        { text: '翻阅上册', action: 'read_vol1' },
                        { text: '寻找下册', action: 'find_vol2' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                piano: {
                    name: '钢琴',
                    description: '一架老旧的立式钢琴，琴键有些发黄。',
                    options: [
                        { text: '尝试弹奏', action: 'play_piano' },
                        { text: '倾听是否有声音', action: 'listen_piano' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                mirror: {
                    name: '镜子',
                    description: '一面普通的镜子，边缘有些锈迹。',
                    options: [
                        { text: '照镜子', action: 'look_mirror' },
                        { text: '检查锈迹', action: 'check_rust' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                sink: {
                    name: '洗手池',
                    description: '一排不锈钢洗手池，水龙头很新。',
                    options: [
                        { text: '洗手', action: 'wash_hands' },
                        { text: '检查水质', action: 'check_water' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                guard: {
                    name: '与门卫交谈',
                    description: '门卫正在查看监控，看起来有些疲惫。',
                    options: [
                        { text: '报告异常', action: 'report_anomaly' },
                        { text: '询问时间', action: 'ask_time' },
                        { text: '离开', action: 'leave' }
                    ]
                },
                monitors: {
                    name: '监控屏幕',
                    description: '多个屏幕显示校园不同区域的实时画面。',
                    options: [
                        { text: '查看教室监控', action: 'watch_classroom' },
                        { text: '查看广场监控', action: 'watch_courtyard' },
                        { text: '离开', action: 'leave' }
                    ]
                }
            },
            rules: [
                "规则1：进入学校前，请确保你的校牌是蓝色的。如果校牌变成红色，立即离开学校并报告门卫。",
                "规则2：门卫永远穿着灰色制服。如果看到穿黑色制服的门卫，不要与他对话，立即进入教学楼。",
                "规则3：校园广场的槐树在中午12点会投下阴影。如果发现阴影方向与太阳位置不符，立即闭上眼睛数到30。",
                "规则4：广场上的鸽子总是成双出现。如果看到单独一只鸽子，不要喂食或接近它。",
                "规则5：教室的窗户在雨天会映出人影。如果数到的人影数量与教室里实际人数不符，不要看向窗户。",
                "规则6：如果听到三楼传来钢琴声，但音乐教室在一楼，不要上楼查看。",
                "规则7：教室里最后一排的座位总是空着的。如果有人坐在那里，不要与他/她说话。",
                "规则8：如果你的同桌突然变得沉默寡言，且眼睛不再眨动，立即报告老师并要求换座位。",
                "规则9：食堂提供的肉类食品如果是红色的，不要食用。",
                "规则10：食堂阿姨总是面带微笑。如果看到面无表情的食堂工作人员，不要从她那里取餐。",
                "规则11：图书馆的《校园历史》一书只有上册。如果发现下册，不要阅读。",
                "规则12：图书管理员戴眼镜。如果看到不戴眼镜的管理员，不要询问任何问题。",
                "规则13：音乐教室的钢琴在无人时会自动演奏。如果听到它演奏《月光奏鸣曲》，立即离开并关上门。",
                "规则14：音乐教室的镜子不会反射人影。如果你在镜中看到自己，不要触碰任何乐器。",
                "规则15：厕所的第三个隔间是锁着的。如果发现它打开了，不要使用它。",
                "规则16：洗手时，如果水变成红色，立即停止使用并报告老师。",
                "规则17：门卫室的时钟总是快5分钟。如果发现它显示准确时间，不要相信它。",
                "规则18：门卫不会在下午4点后接受任何报告。如果他在那个时间后主动与你交谈，不要回应。"
            ],
            items: {
                blue_card: {
                    name: '蓝色校牌',
                    description: '你的学生证，显示你是该校学生。目前是蓝色的。'
                },
                red_card: {
                    name: '红色校牌',
                    description: '你的学生证不知何时变成了红色，这不太对劲。'
                },
                class_key: {
                    name: '教室钥匙',
                    description: '可以打开你所在教室的门。'
                },
                note: {
                    name: '神秘纸条',
                    description: '上面写着"不要相信镜子中的你"。'
                },
                history_vol1: {
                    name: '《校园历史》上册',
                    description: '记录了学校建立初期的历史。'
                },
                history_vol2: {
                    name: '《校园历史》下册',
                    description: '这本书不应该存在...'
                }
            },
            endings: [
                {
                    id: 'normal',
                    title: '普通结局',
                    description: '你平安度过了这一天，没有遇到任何异常。也许规则只是学校管理严格的表现？',
                    type: 'normal'
                },
                {
                    id: 'expelled',
                    title: '开除结局',
                    description: '你违反了太多规则，被学校以"行为不端"为由开除。离开时，你注意到门卫的眼睛闪过一丝红光...',
                    type: 'bad'
                },
                {
                    id: 'disappear',
                    title: '消失结局',
                    description: '没有人再见过你。你的名字从班级名册上消失，就像从未存在过一样。',
                    type: 'bad'
                },
                {
                    id: 'truth',
                    title: '真相结局',
                    description: '你发现了学校的秘密：这些规则是为了保护学生免受某种超自然现象的伤害。现在你成为了新的规则守护者。',
                    type: 'good'
                },
                {
                    id: 'escape',
                    title: '逃脱结局',
                    description: '你成功逃离了学校。回头望去，整座校园在夕阳下显得格外宁静。但你永远不会忘记那些规则...',
                    type: 'good'
                }
            ]
        };

        // DOM元素
        const introScreen = document.getElementById('intro-screen');
        const tutorialScreen = document.getElementById('tutorial-screen');
        const gameScreen = document.getElementById('game-screen');
        const endingScreen = document.getElementById('ending-screen');
        const startGameBtn = document.getElementById('start-game');
        const skipTutorialBtn = document.getElementById('skip-tutorial');
        const startAfterTutorialBtn = document.getElementById('start-after-tutorial');
        const restartGameBtn = document.getElementById('restart-game');
        const moveBtn = document.getElementById('move-btn');
        const interactBtn = document.getElementById('interact-btn');
        const checkInventoryBtn = document.getElementById('check-inventory-btn');
        const viewRulesBtn = document.getElementById('view-rules-btn');
        const moveOptions = document.getElementById('move-options');
        const locationOptions = document.getElementById('location-options');
        const cancelMove = document.getElementById('cancel-move');
        const interactOptions = document.getElementById('interact-options');
        const interactObjects = document.getElementById('interact-objects');
        const cancelInteract = document.getElementById('cancel-interact');
        const inventoryDisplay = document.getElementById('inventory-display');
        const inventoryItems = document.getElementById('inventory-items');
        const closeInventory = document.getElementById('close-inventory');
        const currentRules = document.getElementById('current-rules');
        const locationDescription = document.getElementById('location-description');
        const endingContent = document.getElementById('ending-content');
        const saveGameBtn = document.getElementById('save-game-btn');
        const loadGameBtn = document.getElementById('load-game-btn');
        const saveSlots = document.querySelectorAll('.save-slot');
        const allRulesModal = document.getElementById('all-rules-modal');
        const allRulesList = document.getElementById('all-rules-list');
        const closeAllRulesBtn = document.getElementById('close-all-rules');

        // 初始化游戏
        function initGame() {
            gameState.currentLocation = 'gate';
            gameState.day = 1;
            gameState.time = 'morning';
            gameState.sanity = 100;
            gameState.inventory = ['blue_card'];
            gameState.knownRules = [];
            gameState.brokenRules = [];
            gameState.hasSeen = {};
            gameState.endings = [];
            
            // 初始知道前两条规则
            learnRules([0, 1]);
            
            updateLocation();
            updateRulesDisplay();
        }

        // 学习新规则
        function learnRules(ruleIndices) {
            ruleIndices.forEach(index => {
                if (!gameState.knownRules.includes(index)) {
                    gameState.knownRules.push(index);
                }
            });
        }

        // 违反规则
        function breakRule(ruleIndex) {
            if (!gameState.brokenRules.includes(ruleIndex)) {
                gameState.brokenRules.push(ruleIndex);
                gameState.sanity -= 10 + Math.floor(Math.random() * 10);
                
                if (gameState.sanity <= 0) {
                    triggerEnding('disappear');
                } else if (gameState.brokenRules.length >= 5) {
                    triggerEnding('expelled');
                }
            }
        }

        // 触发结局
        function triggerEnding(endingId) {
            const ending = gameData.endings.find(e => e.id === endingId);
            if (ending) {
                gameState.endings.push(endingId);
                
                endingContent.innerHTML = `
                    <h2>${ending.title}</h2>
                    <p>${ending.description}</p>
                `;
                endingContent.className = `ending ${ending.type}-ending`;
                
                gameScreen.classList.add('hidden');
                endingScreen.classList.remove('hidden');
            }
        }

        // 更新位置显示
        function updateLocation() {
            const location = gameData.locations[gameState.currentLocation];
            locationDescription.innerHTML = `
                <h3>${location.name}</h3>
                <p>${location.description}</p>
                <p><strong>时间：</strong>第${gameState.day}天 ${gameState.time === 'morning' ? '上午' : '下午'}</p>
                <p><strong>理智值：</strong>${gameState.sanity}/100</p>
            `;
            
            // 第一次到达该地点时学习相关规则
            if (!gameState.hasSeen[gameState.currentLocation]) {
                const ruleIndices = [];
                for (let i = 0; i < gameData.rules.length; i++) {
                    if (gameData.rules[i].includes(location.name) && !gameState.knownRules.includes(i)) {
                        ruleIndices.push(i);
                    }
                }
                if (ruleIndices.length > 0) {
                    learnRules(ruleIndices);
                    updateRulesDisplay();
                }
                gameState.hasSeen[gameState.currentLocation] = true;
            }
        }

        // 更新规则显示
        function updateRulesDisplay() {
            currentRules.innerHTML = '';
            gameState.knownRules.forEach(index => {
                const ruleItem = document.createElement('div');
                ruleItem.className = 'rule-item';
                ruleItem.textContent = gameData.rules[index];
                currentRules.appendChild(ruleItem);
            });
        }

        // 显示所有已知规则
        function showAllRules() {
            allRulesList.innerHTML = '';
            if (gameState.knownRules.length === 0) {
                allRulesList.innerHTML = '<p>你还没有了解任何规则。</p>';
            } else {
                gameState.knownRules.forEach(index => {
                    const ruleItem = document.createElement('div');
                    ruleItem.className = 'rule-item';
                    ruleItem.textContent = gameData.rules[index];
                    allRulesList.appendChild(ruleItem);
                });
            }
            allRulesModal.classList.remove('hidden');
        }

        // 显示移动选项
        function showMoveOptions() {
            locationOptions.innerHTML = '';
            const location = gameData.locations[gameState.currentLocation];
            
            location.adjacent.forEach(locId => {
                const loc = gameData.locations[locId];
                const button = document.createElement('button');
                button.textContent = loc.name;
                button.onclick = () => {
                    gameState.currentLocation = locId;
                    moveOptions.classList.add('hidden');
                    updateLocation();
                };
                locationOptions.appendChild(button);
            });
            
            moveOptions.classList.remove('hidden');
        }

        // 显示互动选项
        function showInteractOptions() {
            interactObjects.innerHTML = '';
            const location = gameData.locations[gameState.currentLocation];
            
            location.interactions.forEach(intId => {
                const interaction = gameData.interactions[intId];
                const button = document.createElement('button');
                button.textContent = interaction.name;
                button.onclick = () => {
                    interactWith(intId);
                    interactOptions.classList.add('hidden');
                };
                interactObjects.appendChild(button);
            });
            
            interactOptions.classList.remove('hidden');
        }

        // 互动处理
        function interactWith(interactionId) {
            const interaction = gameData.interactions[interactionId];
            let description = interaction.description;
            let options = [...interaction.options];
            
            // 特殊互动处理
            switch (interactionId) {
                case 'gate_guard':
                    if (gameState.inventory.includes('red_card')) {
                        description += ' 门卫看到你的红色校牌，脸色突然变得苍白："你...你需要立即去医务室！"';
                        options = [
                            { text: '听从门卫', action: 'go_to_infirmary' },
                            { text: '拒绝并进入学校', action: 'enter_anyway' }
                        ];
                    }
                    break;
                case 'old_tree':
                    if (gameState.time === 'noon') {
                        description += ' 树影的方向似乎与太阳的位置不符...';
                        options.unshift({ text: '闭上眼睛数到30', action: 'close_eyes' });
                    }
                    break;
                case 'piano':
                    if (!gameState.hasSeen['piano_played'] && Math.random() < 0.3) {
                        description += ' 突然，钢琴自己开始演奏《月光奏鸣曲》！';
                        gameState.hasSeen['piano_played'] = true;
                        options.unshift({ text: '立即离开并关上门', action: 'leave_quickly' });
                    }
                    break;
            }
            
            const interactionDiv = document.createElement('div');
            interactionDiv.innerHTML = `
                <h4>${interaction.name}</h4>
                <p>${description}</p>
                <div class="actions">
                    ${options.map(opt => `<button onclick="handleInteraction('${interactionId}', '${opt.action}')">${opt.text}</button>`).join('')}
                </div>
            `;
            
            locationDescription.appendChild(interactionDiv);
        }

        // 处理互动动作
        function handleInteraction(interactionId, action) {
            let result = '';
            let ruleBroken = false;
            let ruleIndex = -1;
            let itemGained = null;
            
            // 根据互动和动作处理结果
            switch (`${interactionId}_${action}`) {
                case 'gate_guard_show_blue_card':
                    result = '门卫检查了你的校牌，点点头："可以进去了。"';
                    break;
                case 'gate_guard_show_red_card':
                    result = '门卫看到红色校牌后脸色大变："你不应该在这里！医务室，快去医务室！"';
                    ruleIndex = 0;
                    ruleBroken = true;
                    break;
                case 'gate_guard_no_card':
                    result = '门卫皱眉："没有校牌不能进入。在这里等着。" 你被留在了校门外。';
                    break;
                case 'old_tree_close_eyes':
                    result = '你闭上眼睛数到30。再睁开时，树影恢复了正常。';
                    break;
                case 'old_tree_read_names':
                    if (Math.random() < 0.5) {
                        result = '树干上刻着许多名字，有些已经模糊不清。你注意到有几个名字被反复划掉。';
                        itemGained = 'note';
                    } else {
                        result = '你辨认出几个名字，但没什么特别的发现。';
                    }
                    break;
                case 'piano_play_piano':
                    result = '你弹了几个音符，钢琴发出正常的声响。';
                    break;
                case 'piano_leave_quickly':
                    result = '你迅速离开音乐教室并关上门。钢琴声戛然而止。';
                    break;
                case 'history_book_find_vol2':
                    result = '你在书架深处找到了《校园历史》下册。翻开第一页，上面写着"不要继续读下去"。';
                    itemGained = 'history_vol2';
                    ruleIndex = 10;
                    ruleBroken = true;
                    break;
                case 'sink_wash_hands':
                    if (Math.random() < 0.3) {
                        result = '洗手时，水突然变成了红色！你立即关掉了水龙头。';
                        ruleIndex = 15;
                        ruleBroken = true;
                    } else {
                        result = '你洗了手，水很正常。';
                    }
                    break;
                default:
                    result = '你完成了这个动作，没有发生什么特别的事情。';
            }
            
            // 处理违反规则
            if (ruleBroken && ruleIndex !== -1) {
                breakRule(ruleIndex);
                result += '<br><strong>你似乎违反了某条规则...</strong>';
            }
            
            // 处理获得物品
            if (itemGained && !gameState.inventory.includes(itemGained)) {
                gameState.inventory.push(itemGained);
                result += `<br><strong>获得了：${gameData.items[itemGained].name}</strong>`;
            }
            
            // 显示结果
            const resultDiv = document.createElement('div');
            resultDiv.innerHTML = `<p>${result}</p>`;
            locationDescription.appendChild(resultDiv);
            
            // 检查是否触发结局
            if (gameState.inventory.includes('history_vol2') && gameState.inventory.includes('note')) {
                triggerEnding('truth');
            } else if (gameState.day > 3 && gameState.brokenRules.length === 0) {
                triggerEnding('normal');
            } else if (gameState.currentLocation === 'gate' && gameState.inventory.includes('red_card') && gameState.day > 1) {
                triggerEnding('escape');
            }
            
            // 推进时间
            advanceTime();
        }

        // 推进时间
        function advanceTime() {
            if (gameState.time === 'morning') {
                gameState.time = 'afternoon';
            } else {
                gameState.time = 'morning';
                gameState.day++;
            }
            updateLocation();
        }

        // 显示物品栏
        function showInventory() {
            inventoryItems.innerHTML = '';
            
            if (gameState.inventory.length === 0) {
                inventoryItems.innerHTML = '<p>你的物品栏是空的。</p>';
            } else {
                gameState.inventory.forEach(itemId => {
                    const item = gameData.items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.textContent = item.name;
                    inventoryItems.appendChild(itemDiv);
                });
            }
            
            inventoryDisplay.classList.remove('hidden');
        }

        // 存档功能
        function saveGame(slot) {
            const saveData = JSON.stringify(gameState);
            localStorage.setItem(`school_rules_save_${slot}`, saveData);
            
            // 更新存档槽显示
            const slotElement = document.querySelector(`.save-slot[data-slot="${slot}"]`);
            slotElement.innerHTML = `存档${slot} <span>(第${gameState.day}天)</span>`;
            slotElement.classList.remove('empty');
            
            alert(`游戏已保存到存档${slot}`);
        }

        // 读档功能
        function loadGame(slot) {
            const saveData = localStorage.getItem(`school_rules_save_${slot}`);
            if (saveData) {
                Object.assign(gameState, JSON.parse(saveData));
                updateLocation();
                updateRulesDisplay();
                alert(`已从存档${slot}加载游戏`);
            } else {
                alert(`存档${slot}为空`);
            }
        }

        // 键盘快捷键处理
        function handleKeyPress(e) {
            // 只在游戏界面响应快捷键
            if (gameScreen.classList.contains('hidden')) return;
            
            switch (e.key.toLowerCase()) {
                case 'm':
                    showMoveOptions();
                    break;
                case 'i':
                    showInteractOptions();
                    break;
                case 'c':
                    showInventory();
                    break;
                case 'r':
                    showAllRules();
                    break;
            }
        }

        // 事件监听
        startGameBtn.addEventListener('click', () => {
            introScreen.classList.add('hidden');
            if (!gameState.tutorialCompleted) {
                tutorialScreen.classList.remove('hidden');
            } else {
                gameScreen.classList.remove('hidden');
                initGame();
            }
        });

        skipTutorialBtn.addEventListener('click', () => {
            tutorialScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameState.tutorialCompleted = true;
            initGame();
        });

        startAfterTutorialBtn.addEventListener('click', () => {
            tutorialScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameState.tutorialCompleted = true;
            initGame();
        });

        restartGameBtn.addEventListener('click', () => {
            endingScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            initGame();
        });

        moveBtn.addEventListener('click', showMoveOptions);
        interactBtn.addEventListener('click', showInteractOptions);
        checkInventoryBtn.addEventListener('click', showInventory);
        viewRulesBtn.addEventListener('click', showAllRules);
        
        cancelMove.addEventListener('click', () => {
            moveOptions.classList.add('hidden');
        });

        cancelInteract.addEventListener('click', () => {
            interactOptions.classList.add('hidden');
        });

        closeInventory.addEventListener('click', () => {
            inventoryDisplay.classList.add('hidden');
        });

        closeAllRulesBtn.addEventListener('click', () => {
            allRulesModal.classList.add('hidden');
        });

        saveGameBtn.addEventListener('click', () => {
            if (gameState.selectedSlot) {
                saveGame(gameState.selectedSlot);
                gameState.selectedSlot = null;
            } else {
                alert('请先选择一个存档位');
            }
        });

        loadGameBtn.addEventListener('click', () => {
            if (gameState.selectedSlot) {
                loadGame(gameState.selectedSlot);
                gameState.selectedSlot = null;
            } else {
                alert('请先选择一个存档位');
            }
        });

        saveSlots.forEach(slot => {
            slot.addEventListener('click', () => {
                // 清除之前的选择
                saveSlots.forEach(s => s.style.backgroundColor = '');
                
                // 设置新的选择
                slot.style.backgroundColor = '#ffcdd2';
                gameState.selectedSlot = slot.dataset.slot;
            });
        });

        // 键盘事件监听
        document.addEventListener('keydown', handleKeyPress);

        // 使handleInteraction在全局可用
        window.handleInteraction = handleInteraction;

        // 初始化存档槽显示
        function initSaveSlots() {
            saveSlots.forEach(slot => {
                const slotNum = slot.dataset.slot;
                const saveData = localStorage.getItem(`school_rules_save_${slotNum}`);
                if (saveData) {
                    const savedState = JSON.parse(saveData);
                    slot.innerHTML = `存档${slotNum} <span>(第${savedState.day}天)</span>`;
                    slot.classList.remove('empty');
                }
            });
        }

        initSaveSlots();
    </script>
</body>
</html>